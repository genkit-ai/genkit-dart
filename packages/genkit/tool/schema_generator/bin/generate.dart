// Copyright 2025 Google LLC
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//     http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.

import 'dart:io';
import 'dart:convert';
import 'package:http/http.dart' as http;
import '../lib/src/class_generator.dart';

void main() async {
  final response = await http.get(Uri.parse(
      'https://raw.githubusercontent.com/firebase/genkit/refs/heads/main/genkit-tools/genkit-schema.json'));

  if (response.statusCode == 200) {
    final schema = json.decode(response.body) as Map<String, dynamic>;
    final definitions = schema['\$defs'] as Map<String, dynamic>;

    final allowlist = [
      'Candidate',
      'Message',
      'ToolDefinition',
      'Part',
      'TextPart',
      'MediaPart',
      'ToolRequestPart',
      'ToolResponsePart',
      'DataPart',
      'CustomPart',
      'ReasoningPart',
      'ResourcePart',
      'Media',
      'ToolRequest',
      'ToolResponse',
      'ModelRequest',
      'ModelResponse',
      'ModelResponseChunk',
      'GenerateRequest',
      'GenerationUsage',
      'Operation',
      'OutputConfig',
      'FinishReason',
      'Role',
      'DocumentData',
      'GenerateActionOptions',
      'GenerateActionOutputConfig',
    ];

    final classGenerator = ClassGenerator(definitions);
    final generatedContent = classGenerator.generate(allowlist.toSet());

    final outputFile = File('lib/src/types.dart');
    final fileContent = '''
// This file is generated by tool/schema_generator/bin/generate.dart.
// Do not edit this file manually.

$generatedContent''';
    await outputFile.writeAsString(fileContent);
    print('Successfully generated lib/src/types.dart');
  } else {
    throw Exception('Failed to fetch schema');
  }
}
